## 开发笔记

### 前言  

伸手党不必浪费时间，直接去py文件下载使用就好了。这篇文章是给来提高学习的同学准备的。

应该不会再更新了，一来疫情也差不多结束，该好好工作了；再者下了这么多图片也实在是看不过来，放在文件夹里就没怎么打开过，纯粹占用硬盘空间罢了。

或许只有在下载的那一刻看到命令行里面数字和字符在翻滚的时候心里是愉悦的——这不比写各种编程练习题有意思多了？

细细想来，Python写的爬图的代码对我来说不过是课业之余的消遣，可人家站长说不定家庭困难，全靠这个小小的网站的广告收入来养活一家人，咱们爬了图片自己欣赏欣赏也就好了，还是希望各位朋友不要去复制，传播，影响人家的生计。

作为一个练手项目，基本上可以到此为止，去迎接更多更新更难的挑战了。

别了，诸君。



### 吐槽站长

其实我本来也不知道有这么一个网站，只是当初刚开始入门Python的时候，在CSDN和知乎上看到不少人都以它作为爬虫的实例，反正因为疫情的关系在家里待着没有事做，跟着后面学了学，上手了，觉得OK，也就写了这么一个练手的小项目。

随着网站在去年的易主，发现新网站的拥有者似乎挺自负，总是时不时更改一下网站的结构，给广大爱好者[挖点坑]((https://www.nange.cn/disable-devtool.html))，还写了篇[文章](https://www.nange.cn/i-killed-a-python.html)来嘲讽一下去爬图的人。

不管是所谓的“一键禁用F12开发工具”，还是最新添加的“宝塔防火墙”自动URL跳转，不过是给大家增添了一点小小的难度，对于稍微有些上进心的同学，轻易便可寻出破解之道。

虽然在这个过程中，站长的水平提高了，我们的水平也提高了，大家互相切磋学习，都拥有了一个光明的未来，可是在这个过程中，站长给他的页面上加载了十分夸张的JavaScript脚本和多得令人发指的广告，最近添加的一些脚本，更是像某些国产的流氓软件，把用户的浏览器当肉鸡一样对待，导致访问体验一落千丈。最典型，如iOS系统最新的隐私保护功能和它的某些脚本相冲突，所以一点开页面会自动关闭标签。

如此一来，固然是挡住了某些初学者的窥探企图，可是这么做的结果是失去了来自移动端的访问流浪，可谓是把孩子和洗澡水一齐倒掉。至于某些脚本还调用了一些偏门的使用技巧，导致浏览器的内存使用惊人地暴涨，以至于我用i7的处理器加16GB内存的PC去访问，都卡得快死机了。

至于文件里的各种奇奇怪怪的缺失、错误、命名的无规律，太多嘈点，根本吐槽不过来。

哎，冤冤相报何时了，互联网这么大，能够看到也是缘分一场，虽然挡人财路如杀人父母，可是既然选择公开发布在互联网上，那还是应该多少有点互联网的分享精神才是。如果一心想要盈利，不如考虑用其它的方式来进行版权的约束。与其想着如何给来爬图的人添加困恼，制造麻烦，还不如把心思放在优化上，提升一下访问体验，开拓新的盈利渠道，或许从长远来说，会更有益吧。

如站长有缘看到本文，还望其三思。

---

### 通过最近的更新，又学到了什么啦？

---

**11月更新**

几个月没来，代码一跑意料之中又报错。

仔细一看，网站又加了些新玩意。

![你呀-总是能给我出点新花样，亮剑楚云飞魔性图片表情包.jpg](http://i2.hdslb.com/bfs/archive/a2acc460967d18b561c39390541e9fec1fa10510.jpg)

用浏览器打开一看，就看到URL连着变了好几次，出来一个新URL，哦哟，啥玩意这是？

> https://www.vmgirls.com/archives.html?btwaf=96290722

换了个浏览器试试，后面的btwaf还会跟着变，Google一下，得知这个东西叫做“宝塔防火墙”，名字听起来十分——一言难尽。

想看看源码，刚打开开发者工具浏览器页面就没了，不得不说，这个有点吓人啊，现在你就敢关我的浏览器，下次你想干吗那真是令人想想就不寒而栗啊。

这种小伎俩能难得到我们吗？上代码：

```python
import requests
html = requests.get(url, headers=header)
with open(html_rename, 'w', encoding='utf-8') as f:
    f.write(html.text)
```

打开看到里面的代码：

```html
<html>
<meta charset="utf-8" />
<title>检测中</title>
<div>跳转中</div>
<script async src='/cdn-cgi/challenge-platform/h/g/scripts/invisible.js'></script>
<script
    type="text/javascript">(function () { window['__CF$cv$params'] = { r: '6ac4fb08db393fd8', m: 'UouiXWiAloFT4PBZXWUiIUw3KaDL508t_3t7bjvwoiU-1636607074-0-AY0D0wT36Mx281KF3kBVgUWyxOjk+t7WhJs/iOolvJPuYVadt+JG9+bHj3n3OKV+I8Zs2QDfQYV6tAmWG6idSiG27Q7Ma4G/93UbK/B89oyVRi3w2P5yxHKN/9a6Jistcg==', s: [0xcd16bba2b7, 0xea37344e21], u: '/cdn-cgi/challenge-platform/h/g' } })();</script>

</html>
<script> window.location.href = "/archives.html?btwaf=63617636"; </script>
```

负责跳转JS的脚本放在了`</html>`的后面，所以如果还是用之前的代码直接用BeautifulSoup删掉所有JS脚本的话，就不能找到这一段了。

虽然在stackoverflow.com有一堆方法来实现对`<script>`里面`window.location.href`属性的提取，大佬们都是用的正则表达式，然而我们这样的非生产环境的代码本来也不用讲究什么严谨，能用就行，写那么难的正则既费脑子也容易产生莫名其妙的错误，伟人说白猫黑猫都能抓老鼠那咱们就直接用`replace`方法把`</html>`删了，再把这个字符串加上`</html>`就好啦。这样一操作，`</html>`就从中间跑到最后面去了嘛：

```python
response = requests.get(url, headers=header)
response.encoding = 'utf-8'
soup = BeautifulSoup(response.text, 'lxml')
html = response.text.replace('</html>', '') + '</html>'
```

接下来再用BeautifulSoup来处理就行了：
```python
tag_script = BeautifulSoup(html, 'lxml').find_all('script')[-1]
btwaf = tag_script.string.split("/")[-1].replace('";', '')
```

把它封装成函数，只要被抽中了去做跳转，那我们就调用这一段函数，加一个迭代（自己调用自己），你跳我也跟着你跳，非要跟着你找到最后的URL不可。

运行一下，跳了N回也没有看到尽头。这种情况我们见得多了，去浏览器里一看，果然也没有什么新东西，还是跟请求头（header）里面的`Referer`字段有关，直接把新拿到的加了盐的url写进去就好了。

```python
header['Referer'] = btwaf_url
```

有同学问这是怎么发现的，当然还是用浏览器开发者工具看的，不会真的以为靠那么一句JS脚本，我们就用不了开发者工具了吧，不会吧不会吧不会吧……

既然不让用的指令是JS发出的，那把那个烦人的JS禁用掉或者删掉，不就好了？所以站长应该是被网上充斥着的“一句话教你禁用js脚本”的拙劣教程给坑了。毕竟JS也是要靠HTML来加载嘛，那么大个JS明晃晃写在html里，真的很难让人找不到啊……

```html
 <script async src='/cdn-cgi/challenge-platform/h/g/scripts/invisible.js'></script>
  <script disable-devtool-auto
               src='https://cdn.jsdelivr.net/npm/disable-devtool/disable-devtool.min.js'></script>
 <script src='//t.cdn.ink/wp-content/plugins/deblocker-v3.1.6/js/ads.min.js?ver=3.1.6'
          id=mdp-deblocker-ads-js></script>
```


---

**7月更新**

网站所托管的服务器属Cloudflare旗下，采用了一种自吹很得意的图片压缩技术，在不影响画质的情况下，抛弃了非必要的信息来缩小图片体积。

为了和这样的技术作斗争，不得已，翻越了文献资料，获取了突破缓存命中的方法。

相关详情可参看本目录下的另一篇文章。
